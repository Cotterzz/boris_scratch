<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
  		<meta name="author" content="John Cotterell">
  		<title>Synthesiser</title>
  		<link href="https://fonts.googleapis.com/css?family=Dancing+Script:700|Gruppo" rel="stylesheet">
  		<link type="text/css" rel="stylesheet" href="style.css">
	</head>
	<body>
		<div id="drawing"></div>
		<div id="rootnode">

			<div class="node piano" style="left: 0px; top:100px;">
					<div class="subnode pianokeywhite" id = "24"><div class="keytitle">C</div></div>
					<div class="subnode pianokeyblack" id = "25"><div class="keytitleblack">C#</div></div>
					<div class="subnode pianokeywhite" id = "26"><div class="keytitle">D</div></div>
					<div class="subnode pianokeyblack" id = "27"><div class="keytitleblack">D#</div></div>
					<div class="subnode pianokeywhite" id = "28"><div class="keytitle">E</div></div>
					<div class="subnode pianokeywhite" id = "29"><div class="keytitle">F</div></div>
					<div class="subnode pianokeyblack" id = "30"><div class="keytitleblack">F#</div></div>
					<div class="subnode pianokeywhite" id = "31"><div class="keytitle">G</div></div>
					<div class="subnode pianokeyblack" id = "32"><div class="keytitleblack">G#</div></div>
					<div class="subnode pianokeywhite" id = "33"><div class="keytitle">A</div></div>
					<div class="subnode pianokeyblack" id = "34"><div class="keytitleblack">A#</div></div>
					<div class="subnode pianokeywhite" id = "35"><div class="keytitle">B</div></div>
					<div class="subnode pianokeywhite" id = "36"><div class="keytitle">C</div></div>
					<div class="subnode pianokeyblack" id = "37"><div class="keytitleblack">C#</div></div>
					<div class="subnode pianokeywhite" id = "38"><div class="keytitle">D</div></div>
					<div class="subnode pianokeyblack" id = "39"><div class="keytitleblack">D#</div></div>
					<div class="subnode pianokeywhite" id = "40"><div class="keytitle">E</div></div>
					<div class="subnode pianokeywhite" id = "41"><div class="keytitle">F</div></div>
					<div class="subnode pianokeyblack" id = "42"><div class="keytitleblack">F#</div></div>
					<div class="subnode pianokeywhite" id = "43"><div class="keytitle">G</div></div>
					<div class="subnode pianokeyblack" id = "44"><div class="keytitleblack">G#</div></div>
					<div class="subnode pianokeywhite" id = "45"><div class="keytitle">A</div></div>
					<div class="subnode pianokeyblack" id = "46"><div class="keytitleblack">A#</div></div>
					<div class="subnode pianokeywhite" id = "47"><div class="keytitle">B</div></div>
					<div class="subnode pianokeywhite" id = "48"><div class="keytitle">C</div></div>
					<div class="subnode pianokeyblack" id = "49"><div class="keytitleblack">C#</div></div>
					<div class="subnode pianokeywhite" id = "50"><div class="keytitle">D</div></div>
					<div class="subnode pianokeyblack" id = "51"><div class="keytitleblack">D#</div></div>
					<div class="subnode pianokeywhite" id = "52"><div class="keytitle">E</div></div>
					<div class="subnode pianokeywhite" id = "53"><div class="keytitle">F</div></div>
					<div class="subnode pianokeyblack" id = "54"><div class="keytitleblack">F#</div></div>
					<div class="subnode pianokeywhite" id = "55"><div class="keytitle">G</div></div>
					<div class="subnode pianokeyblack" id = "56"><div class="keytitleblack">G#</div></div>
					<div class="subnode pianokeywhite" id = "57"><div class="keytitle">A</div></div>
					<div class="subnode pianokeyblack" id = "58"><div class="keytitleblack">A#</div></div>
					<div class="subnode pianokeywhite" id = "59"><div class="keytitle">B</div></div>
					<div class="subnode pianokeywhite" id = "60"><div class="keytitle">C</div></div>
					<div class="subnode pianokeyblack" id = "61"><div class="keytitleblack">C#</div></div>
					<div class="subnode pianokeywhite" id = "62"><div class="keytitle">D</div></div>
					<div class="subnode pianokeyblack" id = "63"><div class="keytitleblack">D#</div></div>
					<div class="subnode pianokeywhite" id = "64"><div class="keytitle">E</div></div>
					<div class="subnode pianokeywhite" id = "65"><div class="keytitle">F</div></div>
					<div class="subnode pianokeyblack" id = "66"><div class="keytitleblack">F#</div></div>
					<div class="subnode pianokeywhite" id = "67"><div class="keytitle">G</div></div>
					<div class="subnode pianokeyblack" id = "68"><div class="keytitleblack">G#</div></div>
					<div class="subnode pianokeywhite" id = "69"><div class="keytitle">A</div></div>
					<div class="subnode pianokeyblack" id = "70"><div class="keytitleblack">A#</div></div>
					<div class="subnode pianokeywhite" id = "71"><div class="keytitle">B</div></div>
					<div class="subnode pianokeywhite" id = "72"><div class="keytitle">C</div></div>
					<div class="subnode pianokeyblack" id = "73"><div class="keytitleblack">C#</div></div>
					<div class="subnode pianokeywhite" id = "74"><div class="keytitle">D</div></div>
					<div class="subnode pianokeyblack" id = "75"><div class="keytitleblack">D#</div></div>
					<div class="subnode pianokeywhite" id = "76"><div class="keytitle">E</div></div>
					<div class="subnode pianokeywhite" id = "77"><div class="keytitle">F</div></div>
					<div class="subnode pianokeyblack" id = "78"><div class="keytitleblack">F#</div></div>
					<div class="subnode pianokeywhite" id = "79"><div class="keytitle">G</div></div>
					<div class="subnode pianokeyblack" id = "80"><div class="keytitleblack">G#</div></div>
					<div class="subnode pianokeywhite" id = "81"><div class="keytitle">A</div></div>
					<div class="subnode pianokeyblack" id = "82"><div class="keytitleblack">A#</div></div>
					<div class="subnode pianokeywhite" id = "83"><div class="keytitle">B</div></div>
					<div class="subnode pianokeywhite" id = "84"><div class="keytitle">C</div></div>
					<div class="subnode pianokeyblack" id = "85"><div class="keytitleblack">C#</div></div>
					<div class="subnode pianokeywhite" id = "86"><div class="keytitle">D</div></div>
					<div class="subnode pianokeyblack" id = "87"><div class="keytitleblack">D#</div></div>
					<div class="subnode pianokeywhite" id = "88"><div class="keytitle">E</div></div>
					<div class="subnode pianokeywhite" id = "89"><div class="keytitle">F</div></div>
					<div class="subnode pianokeyblack" id = "90"><div class="keytitleblack">F#</div></div>
					<div class="subnode pianokeywhite" id = "91"><div class="keytitle">G</div></div>
					<div class="subnode pianokeyblack" id = "92"><div class="keytitleblack">G#</div></div>
					<div class="subnode pianokeywhite" id = "93"><div class="keytitle">A</div></div>
					<div class="subnode pianokeyblack" id = "94"><div class="keytitleblack">A#</div></div>
					<div class="subnode pianokeywhite" id = "95"><div class="keytitle">B</div></div>
					<div class="subnode pianokeywhite" id = "96"><div class="keytitle">C</div></div>
					<div class="subnode pianokeyblack" id = "97"><div class="keytitleblack">C#</div></div>
					<div class="subnode pianokeywhite" id = "98"><div class="keytitle">D</div></div>
					<div class="subnode pianokeyblack" id = "99"><div class="keytitleblack">D#</div></div>
					<div class="subnode pianokeywhite" id ="100"><div class="keytitle">E</div></div>
					<div class="subnode pianokeywhite" id ="101"><div class="keytitle">F</div></div>
					<div class="subnode pianokeyblack" id ="102"><div class="keytitleblack">F#</div></div>
					<div class="subnode pianokeywhite" id ="103"><div class="keytitle">G</div></div>
					<div class="subnode pianokeyblack" id ="104"><div class="keytitleblack">G#</div></div>
					<div class="subnode pianokeywhite" id ="105"><div class="keytitle">A</div></div>
					<div class="subnode pianokeyblack" id ="106"><div class="keytitleblack">A#</div></div>
					<div class="subnode pianokeywhite" id ="107"><div class="keytitle">B</div></div>
					<div class="subnode pianokeywhite" id ="108"><div class="keytitle">C</div></div>
					<div class="subnode pianokeyblack" id ="109"><div class="keytitleblack">C#</div></div>
					<div class="subnode pianokeywhite" id ="110"><div class="keytitle">D</div></div>
					<div class="subnode pianokeyblack" id ="111"><div class="keytitleblack">D#</div></div>
					<div class="subnode pianokeywhite" id ="112"><div class="keytitle">E</div></div>
					<div class="subnode pianokeywhite" id ="113"><div class="keytitle">F</div></div>
					<div class="subnode pianokeyblack" id ="114"><div class="keytitleblack">F#</div></div>
					<div class="subnode pianokeywhite" id ="115"><div class="keytitle">G</div></div>
					<div class="subnode pianokeyblack" id ="116"><div class="keytitleblack">G#</div></div>
					<div class="subnode pianokeywhite" id ="117"><div class="keytitle">A</div></div>
					<div class="subnode pianokeyblack" id ="118"><div class="keytitleblack">A#</div></div>
					<div class="subnode pianokeywhite" id ="119"><div class="keytitle">B</div></div>
				</div>
			</div>


			<div class="node settings" style="left:   940px;  top: 10px;position:absolute;">
  				<input type="range" id="volumecontrol" name="volume" min="0" max="1" value="0.1" step="0.05">

  				<input type="range" id="attackcontrol" name="attack" min="0" max="1" value="0.1" step="0.05">

  				<input type="range" id="sustaincontrol" name="sustain" min="0" max="1" value="0.5" step="0.05">

  				<input type="range" id="decaycontrol" name="decay" min="0" max="1" value="0.1" step="0.05">

			</div>

			<div class="node waveform" id="waveform" style="left: 10px; top: 600px;"></div>

			<div class="node waveform" id="waveform2" style="left: 320px; top: 10px;"></div>

			<div class="node waveform" id="waveform3" style="left: 630px; top: 600px;"></div>

			
				
			
		</div>

		<script>
			var keyxindex = 10;
			for (var i = 24; i<120; i++){
				var pkey = document.getElementById(i);
				var modifier = 1-(Math.cos(((i-23)/96)*Math.PI*2));
				var whiteKeyHeight = 70+(modifier*30);
				var whiteKeyWidth = 9+(modifier*10);

				var blackKeyHeight = 40+(modifier*20);
				var blackKeyWidth = 8+(modifier*5);

				if(pkey.classList.contains("pianokeywhite")){
					pkey.style.left = keyxindex + "px";
					pkey.style.height = whiteKeyHeight + "px";
					pkey.style.width = whiteKeyWidth + "px";
					keyxindex+=whiteKeyWidth;
				} else {
					
					pkey.style.height = blackKeyHeight + "px";
					pkey.style.width = blackKeyWidth + "px";
					pkey.style.left = (keyxindex-(blackKeyWidth/2))+"px";
				}
				
			}

			



			var imageCanvas2 = document.createElement( 'canvas' );


			document.getElementById("waveform2").appendChild(imageCanvas2);


			imageCanvas2.width = 320;


			imageCanvas2.height = 40;


			var imageContext2=imageCanvas2.getContext("2d");





			imageContext2.fillRect(0,0,320,40);



			var audioContext = new AudioContext();
			var analyser = audioContext.createAnalyser();

			install (audioContext, imageContext2);


			function install (stream, canvas){
				var formWidth = 320;
				var formHeight = 40;
				//var analyser = stream.createAnalyser();
				analyser.fftSize = 1024;
				var bufferLength = analyser.frequencyBinCount;
				var dataArrayT = new Uint8Array(bufferLength);
				var dataArrayF = new Uint8Array(bufferLength);
				function draw() {
  					drawVisual = requestAnimationFrame(draw);
  					analyser.getByteTimeDomainData(dataArrayT);
  					analyser.getByteFrequencyData(dataArrayF);
  					var xscale = (formWidth/bufferLength);
  					canvas.fillStyle = 'rgba(0, 0, 0, 0.1)';
					canvas.fillRect(0,0,formWidth,formHeight);
  					for(var i = 0; i < bufferLength; i++) {
						canvas.fillStyle = 'rgb(0, 200, 0)';
						canvas.fillRect(i*xscale,formHeight-((dataArrayF[i]/256)*formHeight),1,1);
						canvas.fillStyle = 'rgb(200, 0, 0)';
						canvas.fillRect(i*xscale,(dataArrayT[i]/256)*formHeight,1,1);
  					};
  				
  				}
  				draw();
			}

			//imageContext3.fillStyle = 'rgb(0, 0, 0)';
			//imageContext3.fillRect(0,0,formWidth,formHeight*2);

			
			
			

			var noteValues  =  [8.175,8.66,9.175,9.725,10.30,10.92,11.56,12.25,12.98,13.75,14.57,15.44,
					16.35,17.32,18.35,19.45,20.60,21.83,23.12,24.50,25.96,27.50,29.14,30.87,
					32.70,34.65,36.71,38.89,41.20,43.65,46.25,49.00,51.91,55.00,58.27,61.74,
					65.41,69.30,73.42,77.78,82.41,87.31,92.50,98.00,103.83,110.00,116.54,123.47,
					130.81,138.59,146.83,155.56,164.81,174.61,185.00,196.00,207.65,220.00,233.08,246.94,
					261.63,277.18,293.66,311.13,329.63,349.23,369.99,392.00,415.30,440.00,466.16,493.88,
					523.25,554.37,587.33,622.25,659.26,698.46,739.99,783.99,830.61,880.00,932.33,987.77,
					1046.50,1108.73,1174.66,1244.51,1318.51,1396.91,1479.98,1567.98,1661.22,1760.00,1864.66,1975.53,
					2093.00,2217.46,2349.32,2489.02,2637.02,2793.83,2959.96,3135.96,3322.44,3520.00,3729.31,3951.07,
					4186.01,4435,4699,4978,5274,5588,5920,6272,6645,7040,7459,7902,
					8372.02,8870,9398,9974,10548,11176,11840,12544,13290,14080,14918,15804];



			navigator.requestMIDIAccess().then(onMIDISuccess, onMIDIFailure);

			function onMIDISuccess(midiAccess) {
				console.log("MIDI ON");
				console.log(midiAccess);
				for (var input of midiAccess.inputs.values()){
        			input.onmidimessage = getMIDIMessage;
    			};

   				

    			var inputs = midiAccess.inputs;
    			var outputs = midiAccess.outputs;
			}

			function onMIDIFailure() {
    			console.log('Could not access your MIDI devices.');
			}

function getMIDIMessage(message) {
    var command = message.data[0];
    var note = message.data[1];
    var velocity = (message.data.length > 2) ? message.data[2] : 0; // a velocity value might not be included with a noteOff command

    switch (command) {
        case 144: // noteOn
            if (velocity > 0) {
                noteOn(note, velocity);
            } else {
                noteOff(note);
            }
            break;
        case 128: // noteOff
            noteOff(note);
            break;
        default:
        	console.log(command);
        	break;
        // we could easily expand this switch statement to cover other types of commands such as controllers or sysex
    }
}

function noteOn(note, velocity){
	console.log("ON", note, velocity);
	startWaveNote(note, velocity);
}

function noteOff(note){
	console.log("OFF", note);
	stopWaveNote(note);
}


			var drawing = false;
			
			var gainNode = audioContext.createGain();
			var notes = [];
			var notes2 = [];
			var notes3 = [];
			gainNode.connect(analyser);
			analyser.connect(audioContext.destination);
			for (var i = 0; i<noteValues.length; i++){
				notes[i] = {osc:null, gain:null};
				notes[i].gain = audioContext.createGain();
				notes[i].gain.connect(gainNode);
				notes2[i] = {osc:null, gain:null};
				notes2[i].gain = audioContext.createGain();
				notes2[i].gain.connect(gainNode);
				notes3[i] = {osc:null, gain:null};
				notes3[i].gain = audioContext.createGain();
				notes3[i].gain.connect(gainNode);
			}

			document.addEventListener('mousedown', onDocumentMouseDown, false);

			document.addEventListener('mouseup', onDocumentMouseUp, false);

			document.addEventListener('mousemove', onDocumentMouseMove, false);

			function onDocumentMouseUp(event){
				console.log(event.target);
				if (event.target.parentNode.classList.contains("waveform")){
					drawing = false;
				} else if (event.target.classList.contains("subnode")){
					//event.preventDefault();
    				//playNote(event.target.id);
				} else if (event.target.parentNode.classList.contains("subnode")){
					//event.preventDefault();
    				//playNote(event.target.parentNode.id);
				}
			}

			function onDocumentMouseMove(event){
				if (event.target.parentNode.classList.contains("waveform")){
					if(drawing){moveCanvas(event);}
				} else {
					drawing = false;
				}
			}

			function onDocumentMouseDown(event){
				console.log(event.target);
				if (event.target.parentNode.classList.contains("waveform")){
					drawing = true;
				} else if (event.target.classList.contains("subnode")){
					event.preventDefault();
    				playNote(event.target.id);
				} else if (event.target.parentNode.classList.contains("subnode")){
					event.preventDefault();
    				playNote(event.target.parentNode.id);
				}
			}

			function moveCanvas(event){
				var ctx;
				if(event.target.parentNode.id == "waveform"){
					ctx = imageContext;
				} else if (event.target.parentNode.id == "waveform2"){
					ctx = imageContext2;
				} else if (event.target.parentNode.id == "waveform3"){
					ctx = imageContext3;
				}

				var eventLocation = getEventLocation(event.target.parentNode,event);
				//var pixelData = imageContext.getImageData(eventLocation.x, eventLocation.y, 1, 1).data;

				//var ya = formArray[eventLocation.x-3];
				//var yb = formArray[eventLocation.x-2];
				//var yc = formArray[eventLocation.x];
				//var yd = formArray[eventLocation.x+1];
//
				//ya=(ya+1)*formHeight;
				//yb=(yb+1)*formHeight;
				//yc=(yc+1)*formHeight;
				//yd=(yd+1)*formHeight;

				markPoint(eventLocation.x,eventLocation.y, ctx);
				markPoint(eventLocation.x-1,eventLocation.y, ctx);
				markPoint(eventLocation.x+1,eventLocation.y, ctx);
				//markPoint(eventLocation.x-1,yb, ctx);
				//markPoint(eventLocation.x+1,yc, ctx);
				//markPoint(eventLocation.x-2,(ya+yb)/2, ctx);
				//markPoint(eventLocation.x+2,(yd+yc)/2, ctx);
			//imageContext.fillRect(Math.round(eventLocation.x/pixelWidth),Math.round(eventLocation.y/pixelHeight),brushSize,brushSize);

			}

			function getElementPosition(obj) {
    			var curleft = 0, curtop = 0;
    			if (obj.offsetParent) {
        			do {
            			curleft += obj.offsetLeft;
            			curtop += obj.offsetTop;
        			} while (obj = obj.offsetParent);
        			return { x: curleft, y: curtop };
    			}
    			return undefined;
			}


			function getEventLocation(element,event){
			    // Relies on the getElementPosition function.
			    var pos = getElementPosition(element);
			    console.log(event.pageX, event.pageY, pos.x, pos.y)
			    return {
			    	x: (event.pageX)-pos.x,
			      	y: (event.pageY)-pos.y
			    };
			}

			function startWaveNote(numb, vel){
				drawx=1;
  				//imageContext3.fillStyle = 'rgb(0, 0, 0)';
				//imageContext3.fillRect(0,0,formWidth,formHeight*2);

				var currentNote = notes[numb];
				var currentNote2 = notes2[numb];
				var currentNote3 = notes3[numb];

				var bufferSize = Math.round(44100/noteValues[numb]);

    			currentNote.noiseBuffer = audioContext.createBuffer(1, bufferSize, 44100);
    			currentNote2.noiseBuffer = audioContext.createBuffer(1, bufferSize, 44100);
    			currentNote3.noiseBuffer = audioContext.createBuffer(1, bufferSize, 44100);
    			output = currentNote.noiseBuffer.getChannelData(0);
    			output2 = currentNote2.noiseBuffer.getChannelData(0);
    			output3 = currentNote3.noiseBuffer.getChannelData(0);
    			imageContext.fillStyle = 'rgb(200, 0, 0)';
				for (var i = 0; i < bufferSize; i++) {
    				
    				//console.log(output[i]);
    				
					//imageContext.fillRect(i,(output[i]*100) + 100,1,1);
				}

				currentNote.formNoise = audioContext.createBufferSource();
				currentNote.formNoise.buffer = currentNote.noiseBuffer;
				currentNote.formNoise.loop = true;
				currentNote.formNoise.start(audioContext.currentTime);
				currentNote.formNoise.connect(analyser);

				currentNote.gain.gain.value = 0.5;
				currentNote.gain.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.5);

				currentNote2.formNoise = audioContext.createBufferSource();
				currentNote2.formNoise.buffer = currentNote2.noiseBuffer;
				currentNote2.formNoise.loop = true;
				currentNote2.formNoise.start(audioContext.currentTime);
				currentNote2.formNoise.connect(analyser);

				currentNote2.gain.gain.value = 0;
				currentNote2.gain.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.5);
				currentNote2.gain.gain.linearRampToValueAtTime(0, audioContext.currentTime + 1);


				currentNote3.formNoise = audioContext.createBufferSource();
				currentNote3.formNoise.buffer = currentNote3.noiseBuffer;
				currentNote3.formNoise.loop = true;
				currentNote3.formNoise.start(audioContext.currentTime);
				currentNote3.formNoise.connect(analyser);

				currentNote3.gain.gain.value = 0;
				currentNote3.gain.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 1);
			}

			function stopWaveNote(numb){
				var currentNote = notes[numb];
				var currentNote2 = notes2[numb];
				var currentNote3 = notes3[numb];
				console.log(currentNote);
				///currentNote.gain.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.3);
				currentNote.formNoise.stop(audioContext.currentTime);
				currentNote2.formNoise.stop(audioContext.currentTime);
				currentNote3.gain.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.5);
				currentNote3.formNoise.stop(audioContext.currentTime+0.5);
			}

			function startNote(numb, vel){
				drawx=1;
  				//imageContext3.fillStyle = 'rgb(0, 0, 0)';
				//imageContext3.fillRect(0,0,formWidth,formHeight*2);

				var currentNote = notes[numb];
				console.log(currentNote);
				currentNote.osc = audioContext.createOscillator();
				currentNote.osc.type = 'square';
				currentNote.osc.frequency.value = noteValues[numb];
				currentNote.osc.connect(currentNote.gain);
				currentNote.gain.gain.value = 0;
				var impulseVolume = vel/128;
				var impulseTime = 0.5 - vel/256;
				currentNote.gain.gain.linearRampToValueAtTime(impulseVolume, this.audioContext.currentTime + impulseTime);
				currentNote.osc.start(audioContext.currentTime);
				var sustainVolume = 0.1 + vel/512;
				currentNote.gain.gain.linearRampToValueAtTime(sustainVolume, this.audioContext.currentTime + (impulseTime*2));
			}

			function stopNote(numb){
				var currentNote = notes[numb];
				console.log(currentNote);
				currentNote.gain.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.3);
				currentNote.osc.stop(audioContext.currentTime + 0.3);
			}

			function playNote(noteName){
				drawx=1;
  				//imageContext3.fillStyle = 'rgb(0, 0, 0)';
				//imageContext3.fillRect(0,0,formWidth,formHeight*2);

				var currentNote = notes[parseInt(noteName)];
				console.log(currentNote);
				currentNote.osc = audioContext.createOscillator();
				currentNote.osc.type = 'triangle';
				currentNote.osc.frequency.value = noteValues[parseInt(noteName)];
				currentNote.osc.connect(currentNote.gain);
				currentNote.gain.gain.value = 0;
				currentNote.gain.gain.linearRampToValueAtTime(Number(document.getElementById("volumecontrol").value), this.audioContext.currentTime + Number(document.getElementById("attackcontrol").value));
				currentNote.osc.start(audioContext.currentTime); // start now
				var totalTime = Number(document.getElementById("attackcontrol").value) + Number(document.getElementById("sustaincontrol").value) + Number(document.getElementById("decaycontrol").value);
				console.log(totalTime);
				currentNote.gain.gain.linearRampToValueAtTime(Number(document.getElementById("volumecontrol").value), audioContext.currentTime + (totalTime-Number(document.getElementById("decaycontrol").value)));
				currentNote.gain.gain.linearRampToValueAtTime(0, audioContext.currentTime + totalTime);
				currentNote.osc.stop(audioContext.currentTime + totalTime); // stop in 2 seconds
			}

		</script>
	</body>
</html>